import React from 'react';
import { render, screen, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import '@testing-library/jest-dom';
import ClientsSection from '../ClientsSection';
import { clientsAPI } from '../../../../lib/api';
import { filterClients } from '../../../../utils/adminHelpers';

// Mock das depend√™ncias
jest.mock('../../../../lib/api', () => ({
  clientsAPI: {
    getAll: jest.fn(),
    create: jest.fn(),
    update: jest.fn(),
    delete: jest.fn(),
  },
}));

jest.mock('../../../../utils/adminHelpers', () => ({
  filterClients: jest.fn(),
}));

// Mock de dados de teste
const mockClients = [
  {
    id: 1,
    name: 'Jo√£o Silva Santos',
    whatsapp: '(11) 99999-1234',
    phone: '(11) 99999-1234',
    street: 'Rua das Flores',
    number: '123',
    neighborhood: 'Centro',
    city: 'S√£o Paulo',
    zipCode: '01001-000',
    address: 'Rua das Flores, 123 - Centro',
    status: 'active',
    createdAt: '2024-01-15T10:30:00Z',
    orderCount: 25,
    lastOrder: '2024-12-08T14:30:00Z',
    totalValue: 1250.75
  },
  {
    id: 2,
    name: 'Maria Oliveira',
    whatsapp: '(11) 98888-5678',
    phone: '(11) 98888-5678',
    street: 'Av. Paulista',
    number: '456',
    neighborhood: 'Bela Vista',
    city: 'S√£o Paulo',
    zipCode: '01310-100',
    address: 'Av. Paulista, 456 - Bela Vista',
    status: 'inactive',
    createdAt: '2024-02-20T09:15:00Z',
    orderCount: 8,
    lastOrder: '2024-11-15T18:45:00Z',
    totalValue: 650.40
  },
  {
    id: 3,
    name: 'Carlos Pereira',
    whatsapp: '(11) 97777-9012',
    phone: '(11) 97777-9012',
    street: 'Rua Augusta',
    number: '789',
    neighborhood: 'Consola√ß√£o',
    city: 'S√£o Paulo',
    zipCode: '01305-001',
    address: 'Rua Augusta, 789 - Consola√ß√£o',
    status: 'active',
    createdAt: '2024-03-10T16:20:00Z',
    orderCount: 15,
    lastOrder: '2024-12-05T20:15:00Z',
    totalValue: 890.25
  },
];

// Props padr√£o para o componente
const defaultProps = {
  clients: mockClients,
  onRefresh: jest.fn(),
};

describe('ClientsSection', () => {
  beforeEach(() => {
    jest.clearAllMocks();
    clientsAPI.getAll.mockResolvedValue(mockClients);
    filterClients.mockImplementation((clients, searchTerm) => {
      if (!searchTerm) return clients;
      return clients.filter(client =>
        client.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        client.whatsapp.includes(searchTerm)
      );
    });
  });

  // TESTES DE RENDERIZA√á√ÉO B√ÅSICA
  describe('Renderiza√ß√£o', () => {
    test('renderiza o t√≠tulo principal', () => {
      render(<ClientsSection {...defaultProps} />);
      
      expect(screen.getByText('üë• Gerenciar Clientes')).toBeInTheDocument();
    });

    test('exibe contador de clientes', () => {
      render(<ClientsSection {...defaultProps} />);
      
      expect(screen.getByText(/üßë‚Äçüíº Clientes \(3\)/)).toBeInTheDocument();
    });

    test('renderiza bot√£o de novo cliente', () => {
      render(<ClientsSection {...defaultProps} />);
      
      expect(screen.getByRole('button', { name: /novo cliente/i })).toBeInTheDocument();
    });

    test('renderiza campo de busca', () => {
      render(<ClientsSection {...defaultProps} />);
      
      const searchField = screen.getByPlaceholderText('Buscar clientes...');
      expect(searchField).toBeInTheDocument();
    });

    test('renderiza cabe√ßalhos da tabela', () => {
      render(<ClientsSection {...defaultProps} />);
      
      expect(screen.getByText('Cliente')).toBeInTheDocument();
      expect(screen.getByText('Contato')).toBeInTheDocument();
      expect(screen.getByText('Localiza√ß√£o')).toBeInTheDocument();
      expect(screen.getByText('Status')).toBeInTheDocument();
      expect(screen.getByText('A√ß√µes')).toBeInTheDocument();
    });

    test('renderiza todos os clientes na tabela', () => {
      render(<ClientsSection {...defaultProps} />);
      
      expect(screen.getAllByText('Jo√£o Silva Santos')).toHaveLength(1);
      expect(screen.getByText('Maria Oliveira')).toBeInTheDocument();
      expect(screen.getByText('Pedro Santos')).toBeInTheDocument();
    });
  });

  // TESTES DE FUNCIONALIDADE DE BUSCA
  describe('Funcionalidade de Busca', () => {
    test('filtra clientes por nome', async () => {
      const user = userEvent.setup();
      render(<ClientsSection {...defaultProps} />);
      
      const searchField = screen.getByPlaceholderText('Buscar clientes...');
      await user.type(searchField, 'Jo√£o');
      
      await waitFor(() => {
        expect(filterClients).toHaveBeenCalledWith(mockClients, 'Jo√£o');
      });
    });

    test('limpa busca quando campo √© limpo', async () => {
      const user = userEvent.setup();
      render(<ClientsSection {...defaultProps} />);
      
      const searchField = screen.getByPlaceholderText('Buscar clientes...');
      await user.type(searchField, 'Jo√£o');
      await user.clear(searchField);
      
      await waitFor(() => {
        expect(filterClients).toHaveBeenCalledWith(mockClients, '');
      });
    });
  });

  // TESTES DE A√á√ïES CRUD
  describe('A√ß√µes de CRUD', () => {
    test('abre di√°logo de cria√ß√£o ao clicar em Novo Cliente', async () => {
      const user = userEvent.setup();
      render(<ClientsSection {...defaultProps} />);
      
      await user.click(screen.getByRole('button', { name: /novo cliente/i }));
      
      await waitFor(() => {
        expect(screen.getByText('üë§ Adicionar Novo Cliente')).toBeInTheDocument();
      });
    });

    test('abre di√°logo de visualiza√ß√£o ao clicar no bot√£o visualizar', async () => {
      const user = userEvent.setup();
      render(<ClientsSection {...defaultProps} />);
      
      const visibilityIcons = document.querySelectorAll('[data-testid="VisibilityIcon"]');
      await user.click(visibilityIcons[0]);
      
      await waitFor(() => {
        expect(screen.getByText('üëÅÔ∏è Detalhes do Cliente')).toBeInTheDocument();
        expect(screen.getAllByText('Jo√£o Silva Santos')).toHaveLength(2);
      });
    });

    test('mostra informa√ß√µes detalhadas no di√°logo de visualiza√ß√£o', async () => {
      const user = userEvent.setup();
      render(<ClientsSection {...defaultProps} />);
      
      const viewButtons = document.querySelectorAll('[data-testid="VisibilityIcon"]');
      await user.click(viewButtons[0]);
      
      await waitFor(() => {
        expect(screen.getAllByText('Jo√£o Silva Santos')).toHaveLength(2);
        expect(screen.getByText('(11) 99999-1234')).toBeInTheDocument();
        expect(screen.getByText('Rua das Flores, 123')).toBeInTheDocument();
        expect(screen.getByText('Total de pedidos:')).toBeInTheDocument();
      });
    });

    test('exibe di√°logo de confirma√ß√£o ao tentar deletar', async () => {
      const user = userEvent.setup();
      render(<ClientsSection {...defaultProps} />);
      
      const deleteIcons = document.querySelectorAll('[data-testid="DeleteIcon"]');
      await user.click(deleteIcons[0]);
      
      await waitFor(() => {
        expect(screen.getByText('üóëÔ∏è Confirmar Exclus√£o')).toBeInTheDocument();
      });
    });
  });

  // TESTES DE FORMATA√á√ÉO
  describe('Formata√ß√£o de Dados', () => {
    test('formata datas corretamente', () => {
      render(<ClientsSection {...defaultProps} />);
      
      // Verifica se as datas s√£o formatadas para pt-BR
      expect(screen.getAllByText(/Cliente desde/).length).toBeGreaterThan(0);
      expect(screen.getAllByText(/√öltimo:/).length).toBeGreaterThan(0);
    });

    test('exibe status com labels traduzidos', () => {
      render(<ClientsSection {...defaultProps} />);
      
      expect(screen.getAllByText('Ativo').length).toBeGreaterThan(0);
      expect(screen.getAllByText('Inativo').length).toBeGreaterThan(0);
    });

    test('exibe endere√ßo formatado corretamente', () => {
      render(<ClientsSection {...defaultProps} />);
      
      expect(screen.getByText('Rua das Flores, 123')).toBeInTheDocument();
      expect(screen.getByText('Centro - S√£o Paulo')).toBeInTheDocument();
      expect(screen.getByText('CEP: 01234-567')).toBeInTheDocument();
    });

    test('formata valores monet√°rios corretamente', () => {
      render(<ClientsSection {...defaultProps} />);
      
      expect(screen.getByText('R$ 1.250,75')).toBeInTheDocument();
      expect(screen.getByText('R$ 650,40')).toBeInTheDocument();
    });
  });

  // TESTES DE TRATAMENTO DE ERROS
  describe('Tratamento de Erros', () => {
    test('loga erro quando exclus√£o falha', async () => {
      const user = userEvent.setup();
      const consoleSpy = jest.spyOn(console, 'error').mockImplementation(() => {});
      clientsAPI.delete.mockRejectedValue(new Error('Erro na API'));
      
      render(<ClientsSection {...defaultProps} />);
      
      const deleteIcons = document.querySelectorAll('[data-testid="DeleteIcon"]');
      await user.click(deleteIcons[0]);
      
      await waitFor(() => {
        expect(screen.getByText('üóëÔ∏è Confirmar Exclus√£o')).toBeInTheDocument();
      });
      
      await user.click(screen.getByRole('button', { name: /excluir/i }));
      
      await waitFor(() => {
        expect(consoleSpy).toHaveBeenCalledWith('Erro ao deletar cliente:', expect.any(Error));
      });
      
      consoleSpy.mockRestore();
    });
  });

  // TESTES DE ACESSIBILIDADE
  describe('Acessibilidade', () => {
    test('bot√µes t√™m labels apropriados', () => {
      render(<ClientsSection {...defaultProps} />);
      
      expect(screen.getByRole('button', { name: /novo cliente/i })).toBeInTheDocument();
      
      // Verifica pelos √≠cones j√° que n√£o h√° aria-labels nos bot√µes
      const visibilityIcons = document.querySelectorAll('[data-testid="VisibilityIcon"]');
      const editIcons = document.querySelectorAll('[data-testid="EditIcon"]');
      const deleteIcons = document.querySelectorAll('[data-testid="DeleteIcon"]');
      
      expect(visibilityIcons).toHaveLength(3);
      expect(editIcons).toHaveLength(3);
      expect(deleteIcons).toHaveLength(3);
    });

    test('componente √© acess√≠vel via teclado', () => {
      render(<ClientsSection {...defaultProps} />);
      
      const searchField = screen.getByPlaceholderText('Buscar clientes...');
      const newClientButton = screen.getByRole('button', { name: /novo cliente/i });
      
      expect(searchField).toBeInTheDocument();
      expect(newClientButton).toBeInTheDocument();
      
      // Verifica se os elementos podem receber foco
      searchField.focus();
      expect(searchField).toHaveFocus();
      
      newClientButton.focus();
      expect(newClientButton).toHaveFocus();
    });
  });

  // TESTES DE CASOS EXTREMOS
  describe('Casos Extremos', () => {
    test('renderiza mensagem quando n√£o h√° clientes', () => {
      render(<ClientsSection {...defaultProps} clients={[]} />);
      
      expect(screen.getByText(/üßë‚Äçüíº Clientes \(0\)/)).toBeInTheDocument();
    });

    test('lida com cliente sem endere√ßo completo', () => {
      const clienteIncompleto = {
        ...mockClients[0],
        street: 'Rua Teste',
        number: '123',
        neighborhood: null,
        city: 'S√£o Paulo',
        address: 'Rua Teste, 123'
      };
      
      render(<ClientsSection {...defaultProps} clients={[clienteIncompleto]} />);
      
      expect(screen.getByText('Jo√£o Silva Santos')).toBeInTheDocument();
    });

    test('lida com datas inv√°lidas', () => {
      const clienteDataInvalida = {
        ...mockClients[0],
        createdAt: 'data-invalida',
        lastOrder: null
      };
      
      render(<ClientsSection {...defaultProps} clients={[clienteDataInvalida]} />);
      
      expect(screen.getByText('Jo√£o Silva Santos')).toBeInTheDocument();
    });
  });
});