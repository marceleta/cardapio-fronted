/**
 * TESTES DO COMPONENTE - DELIVERY STEP
 * 
 * Conjunto de testes para validar o comportamento e funcionalidades
 * do componente DeliveryStep (PASSO 2: Sele√ß√£o do Tipo de Entrega).
 * 
 * Cobertura:
 * - Renderiza√ß√£o correta
 * - Sele√ß√£o de tipos de entrega
 * - Formul√°rio de endere√ßo
 * - Valida√ß√µes de entrada
 * - C√°lculo de taxas
 * - Casos extremos e tratamento de erros
 */

import React from 'react';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import '@testing-library/jest-dom';

// Componente sendo testado
import DeliveryStep from '../steps/DeliveryStep';

// Utilit√°rios de teste customizados
import {
  renderWithCheckoutProviders,
  createMockAuthContext,
  createMockCheckoutContext,
  createMockAddress,
  createMockUser,
  fillAddressForm,
  waitForDelay
} from './test-utils';

// Mocks de depend√™ncias
jest.mock('../../../context/AuthContext');
jest.mock('../../../context/CheckoutContext');

/**
 * SUITE DE TESTES PRINCIPAL
 */
describe('DeliveryStep - Etapa de Entrega', () => {
  // Mocks padr√£o para testes
  let mockAuthContext;
  let mockCheckoutContext;

  // Configura√ß√£o antes de cada teste
  beforeEach(() => {
    jest.clearAllMocks();
    
    mockAuthContext = createMockAuthContext({
      user: createMockUser({
        addresses: [
          createMockAddress({
            id: '1',
            street: 'Rua das Flores, 123',
            neighborhood: 'Centro',
            isDefault: true
          })
        ]
      })
    });
    
    mockCheckoutContext = createMockCheckoutContext({
      deliveryType: null,
      deliveryAddress: null,
      deliveryFee: 0
    });
    
    // Mock dos hooks de contexto
    require('../../../context/AuthContext').useAuth.mockReturnValue(mockAuthContext);
    require('../../../context/CheckoutContext').useCheckout.mockReturnValue(mockCheckoutContext);
  });

  /**
   * HELPER: Renderiza componente DeliveryStep com contextos mockados
   */
  const renderDeliveryStep = (authOverrides = {}, checkoutOverrides = {}) => {
    const authContext = { ...mockAuthContext, ...authOverrides };
    const checkoutContext = { ...mockCheckoutContext, ...checkoutOverrides };
    
    require('../../../context/AuthContext').useAuth.mockReturnValue(authContext);
    require('../../../context/CheckoutContext').useCheckout.mockReturnValue(checkoutContext);
    
    return renderWithCheckoutProviders(<DeliveryStep />);
  };

  /**
   * GRUPO: Testes de Renderiza√ß√£o
   */
  describe('Renderiza√ß√£o', () => {
    test('deve renderizar o componente corretamente', () => {
      // ACT: Renderizar componente
      renderDeliveryStep();

      // ASSERT: Verificar elementos principais
      expect(screen.getByText('Como voc√™ quer receber?')).toBeInTheDocument();
      expect(screen.getByText('Escolha o tipo de entrega do seu pedido')).toBeInTheDocument();
      expect(screen.getByText('üè™ Retirada no Local')).toBeInTheDocument();
      expect(screen.getByText('üõµ Entrega')).toBeInTheDocument();
    });

    test('deve mostrar informa√ß√µes da retirada no local', () => {
      // ACT: Renderizar componente
      renderDeliveryStep();

      // ASSERT: Verificar detalhes da retirada
      expect(screen.getByText('Gratuito')).toBeInTheDocument();
      expect(screen.getByText('Retire seu pedido diretamente em nossa loja')).toBeInTheDocument();
      expect(screen.getByText('Pronto em 15-20 minutos')).toBeInTheDocument();
    });

    test('deve mostrar informa√ß√µes da entrega', () => {
      // ACT: Renderizar componente
      renderDeliveryStep();

      // ASSERT: Verificar detalhes da entrega
      expect(screen.getByText('A partir de R$ 5,00')).toBeInTheDocument();
      expect(screen.getByText('Entregamos na sua casa ou escrit√≥rio')).toBeInTheDocument();
      expect(screen.getByText('30-45 minutos')).toBeInTheDocument();
    });

    test('deve renderizar endere√ßos salvos quando existe usu√°rio logado', () => {
      // ACT: Renderizar componente
      renderDeliveryStep();

      // ASSERT: Verificar se endere√ßos s√£o mostrados
      expect(screen.getByText('Rua das Flores, 123')).toBeInTheDocument();
      expect(screen.getByText('Centro')).toBeInTheDocument();
    });
  });

  /**
   * GRUPO: Testes de Sele√ß√£o de Tipo de Entrega
   */
  describe('Sele√ß√£o de Tipo de Entrega', () => {
    test('deve selecionar retirada no local', async () => {
      // ARRANGE: Configurar userEvent
      const user = userEvent.setup();

      // ACT: Renderizar e selecionar retirada
      renderDeliveryStep();
      const pickupCard = screen.getByTestId('pickup-option');
      await user.click(pickupCard);

      // ASSERT: Verificar que setDeliveryType foi chamado
      expect(mockCheckoutContext.setDeliveryType).toHaveBeenCalledWith('pickup');
      expect(mockCheckoutContext.setDeliveryFee).toHaveBeenCalledWith(0);
    });

    test('deve selecionar entrega e mostrar formul√°rio de endere√ßo', async () => {
      // ARRANGE: Configurar userEvent
      const user = userEvent.setup();

      // ACT: Renderizar e selecionar entrega
      renderDeliveryStep();
      const deliveryCard = screen.getByTestId('delivery-option');
      await user.click(deliveryCard);

      // ASSERT: Verificar que setDeliveryType foi chamado
      expect(mockCheckoutContext.setDeliveryType).toHaveBeenCalledWith('delivery');

      // ASSERT: Verificar que formul√°rio de endere√ßo apareceu
      await waitFor(() => {
        expect(screen.getByText('Endere√ßo de Entrega')).toBeInTheDocument();
      });
    });

    test('deve marcar visualmente op√ß√£o selecionada', async () => {
      // ARRANGE: Configurar userEvent
      const user = userEvent.setup();

      // ACT: Renderizar e selecionar retirada
      renderDeliveryStep();
      const pickupCard = screen.getByTestId('pickup-option');
      await user.click(pickupCard);

      // ASSERT: Verificar marca√ß√£o visual
      expect(pickupCard).toHaveClass('selected');
    });

    test('deve permitir mudan√ßa de tipo de entrega', async () => {
      // ARRANGE: Configurar userEvent
      const user = userEvent.setup();

      // ACT: Selecionar entrega primeiro, depois retirada
      renderDeliveryStep();
      
      const deliveryCard = screen.getByTestId('delivery-option');
      await user.click(deliveryCard);
      
      const pickupCard = screen.getByTestId('pickup-option');
      await user.click(pickupCard);

      // ASSERT: Verificar mudan√ßa
      expect(mockCheckoutContext.setDeliveryType).toHaveBeenCalledWith('delivery');
      expect(mockCheckoutContext.setDeliveryType).toHaveBeenCalledWith('pickup');
    });
  });

  /**
   * GRUPO: Testes de Endere√ßos Salvos
   */
  describe('Endere√ßos Salvos', () => {
    test('deve listar endere√ßos salvos do usu√°rio', () => {
      // ARRANGE: Usu√°rio com m√∫ltiplos endere√ßos
      const userWithMultipleAddresses = createMockUser({
        addresses: [
          createMockAddress({
            id: '1',
            street: 'Rua A, 123',
            neighborhood: 'Centro',
            isDefault: true
          }),
          createMockAddress({
            id: '2',
            street: 'Rua B, 456',
            neighborhood: 'Vila Nova',
            isDefault: false
          })
        ]
      });

      // ACT: Renderizar com m√∫ltiplos endere√ßos
      renderDeliveryStep({ user: userWithMultipleAddresses });

      // ASSERT: Verificar que ambos endere√ßos s√£o mostrados
      expect(screen.getByText('Rua A, 123')).toBeInTheDocument();
      expect(screen.getByText('Rua B, 456')).toBeInTheDocument();
      expect(screen.getByText('Centro')).toBeInTheDocument();
      expect(screen.getByText('Vila Nova')).toBeInTheDocument();
    });

    test('deve marcar endere√ßo padr√£o visualmente', () => {
      // ACT: Renderizar componente
      renderDeliveryStep();

      // ASSERT: Verificar marca√ß√£o do endere√ßo padr√£o
      const defaultBadge = screen.getByText('Padr√£o');
      expect(defaultBadge).toBeInTheDocument();
    });

    test('deve selecionar endere√ßo salvo', async () => {
      // ARRANGE: Configurar userEvent
      const user = userEvent.setup();

      // ACT: Selecionar entrega e depois endere√ßo
      renderDeliveryStep();
      
      const deliveryCard = screen.getByTestId('delivery-option');
      await user.click(deliveryCard);
      
      await waitFor(() => {
        const addressCard = screen.getByTestId('saved-address-1');
        return user.click(addressCard);
      });

      // ASSERT: Verificar que endere√ßo foi selecionado
      expect(mockCheckoutContext.setDeliveryAddress).toHaveBeenCalledWith(
        expect.objectContaining({
          id: '1',
          street: 'Rua das Flores, 123'
        })
      );
    });

    test('deve calcular taxa de entrega ao selecionar endere√ßo', async () => {
      // ARRANGE: Configurar userEvent e mock de c√°lculo
      const user = userEvent.setup();
      mockCheckoutContext.calculateDeliveryFee.mockResolvedValue(8.50);

      // ACT: Selecionar entrega e endere√ßo
      renderDeliveryStep();
      
      const deliveryCard = screen.getByTestId('delivery-option');
      await user.click(deliveryCard);
      
      await waitFor(() => {
        const addressCard = screen.getByTestId('saved-address-1');
        return user.click(addressCard);
      });

      // ASSERT: Verificar que taxa foi calculada
      expect(mockCheckoutContext.calculateDeliveryFee).toHaveBeenCalled();
      expect(mockCheckoutContext.setDeliveryFee).toHaveBeenCalledWith(8.50);
    });
  });

  /**
   * GRUPO: Testes de Novo Endere√ßo
   */
  describe('Novo Endere√ßo', () => {
    test('deve mostrar formul√°rio para novo endere√ßo', async () => {
      // ARRANGE: Configurar userEvent
      const user = userEvent.setup();

      // ACT: Selecionar entrega e clicar em adicionar endere√ßo
      renderDeliveryStep();
      
      const deliveryCard = screen.getByTestId('delivery-option');
      await user.click(deliveryCard);
      
      await waitFor(() => {
        const addButton = screen.getByText('Adicionar Novo Endere√ßo');
        return user.click(addButton);
      });

      // ASSERT: Verificar campos do formul√°rio
      await waitFor(() => {
        expect(screen.getByLabelText(/CEP/i)).toBeInTheDocument();
        expect(screen.getByLabelText(/Rua/i)).toBeInTheDocument();
        expect(screen.getByLabelText(/N√∫mero/i)).toBeInTheDocument();
        expect(screen.getByLabelText(/Bairro/i)).toBeInTheDocument();
      });
    });

    test('deve preencher endere√ßo automaticamente via CEP', async () => {
      // ARRANGE: Configurar userEvent e mock de CEP
      const user = userEvent.setup();
      global.fetch = jest.fn().mockResolvedValue({
        ok: true,
        json: () => Promise.resolve({
          logradouro: 'Rua das Palmeiras',
          bairro: 'Jardim Am√©rica',
          localidade: 'S√£o Paulo',
          uf: 'SP'
        })
      });

      // ACT: Preencher CEP
      renderDeliveryStep();
      
      const deliveryCard = screen.getByTestId('delivery-option');
      await user.click(deliveryCard);
      
      await waitFor(async () => {
        const addButton = screen.getByText('Adicionar Novo Endere√ßo');
        await user.click(addButton);
      });
      
      await waitFor(async () => {
        const cepField = screen.getByLabelText(/CEP/i);
        await user.type(cepField, '01310100');
      });

      // ASSERT: Verificar preenchimento autom√°tico
      await waitFor(() => {
        expect(screen.getByDisplayValue('Rua das Palmeiras')).toBeInTheDocument();
        expect(screen.getByDisplayValue('Jardim Am√©rica')).toBeInTheDocument();
      });
    });

    test('deve validar campos obrigat√≥rios do endere√ßo', async () => {
      // ARRANGE: Configurar userEvent
      const user = userEvent.setup();

      // ACT: Tentar salvar endere√ßo sem preencher
      renderDeliveryStep();
      
      const deliveryCard = screen.getByTestId('delivery-option');
      await user.click(deliveryCard);
      
      await waitFor(async () => {
        const addButton = screen.getByText('Adicionar Novo Endere√ßo');
        await user.click(addButton);
      });
      
      await waitFor(async () => {
        const saveButton = screen.getByText('Salvar Endere√ßo');
        await user.click(saveButton);
      });

      // ASSERT: Verificar mensagens de valida√ß√£o
      await waitFor(() => {
        expect(screen.getByText('CEP √© obrigat√≥rio')).toBeInTheDocument();
      });
    });

    test('deve salvar novo endere√ßo corretamente', async () => {
      // ARRANGE: Configurar userEvent e mock
      const user = userEvent.setup();
      mockAuthContext.addAddress.mockResolvedValue({
        success: true,
        address: createMockAddress({ id: '2' })
      });

      // ACT: Preencher e salvar novo endere√ßo
      renderDeliveryStep();
      
      const deliveryCard = screen.getByTestId('delivery-option');
      await user.click(deliveryCard);
      
      await waitFor(async () => {
        const addButton = screen.getByText('Adicionar Novo Endere√ßo');
        await user.click(addButton);
      });
      
      await fillAddressForm(user, {
        cep: '01310-100',
        street: 'Rua Nova',
        number: '456',
        neighborhood: 'Centro',
        complement: 'Apt 12'
      });
      
      await waitFor(async () => {
        const saveButton = screen.getByText('Salvar Endere√ßo');
        await user.click(saveButton);
      });

      // ASSERT: Verificar que addAddress foi chamado
      expect(mockAuthContext.addAddress).toHaveBeenCalledWith({
        cep: '01310-100',
        street: 'Rua Nova',
        number: '456',
        neighborhood: 'Centro',
        complement: 'Apt 12',
        isDefault: false
      });
    });

    test('deve formatar CEP automaticamente', async () => {
      // ARRANGE: Configurar userEvent
      const user = userEvent.setup();

      // ACT: Digitar CEP
      renderDeliveryStep();
      
      const deliveryCard = screen.getByTestId('delivery-option');
      await user.click(deliveryCard);
      
      await waitFor(async () => {
        const addButton = screen.getByText('Adicionar Novo Endere√ßo');
        await user.click(addButton);
      });
      
      await waitFor(async () => {
        const cepField = screen.getByLabelText(/CEP/i);
        await user.type(cepField, '01310100');
      });

      // ASSERT: Verificar formata√ß√£o
      const cepField = screen.getByLabelText(/CEP/i);
      expect(cepField.value).toBe('01310-100');
    });
  });

  /**
   * GRUPO: Testes de C√°lculo de Taxa
   */
  describe('C√°lculo de Taxa de Entrega', () => {
    test('deve calcular taxa baseada na dist√¢ncia', async () => {
      // ARRANGE: Configurar mock de c√°lculo
      const user = userEvent.setup();
      mockCheckoutContext.calculateDeliveryFee.mockResolvedValue(12.00);

      // ACT: Selecionar entrega e endere√ßo
      renderDeliveryStep();
      
      const deliveryCard = screen.getByTestId('delivery-option');
      await user.click(deliveryCard);
      
      await waitFor(() => {
        const addressCard = screen.getByTestId('saved-address-1');
        return user.click(addressCard);
      });

      // ASSERT: Verificar c√°lculo
      await waitFor(() => {
        expect(screen.getByText('Taxa de entrega: R$ 12,00')).toBeInTheDocument();
      });
    });

    test('deve mostrar mensagem quando endere√ßo est√° fora da √°rea', async () => {
      // ARRANGE: Configurar mock para √°rea n√£o atendida
      const user = userEvent.setup();
      mockCheckoutContext.calculateDeliveryFee.mockResolvedValue(null);

      // ACT: Selecionar endere√ßo fora da √°rea
      renderDeliveryStep();
      
      const deliveryCard = screen.getByTestId('delivery-option');
      await user.click(deliveryCard);
      
      await waitFor(() => {
        const addressCard = screen.getByTestId('saved-address-1');
        return user.click(addressCard);
      });

      // ASSERT: Verificar mensagem de erro
      await waitFor(() => {
        expect(screen.getByText('N√£o entregamos nesta regi√£o')).toBeInTheDocument();
      });
    });

    test('deve mostrar loading durante c√°lculo de taxa', async () => {
      // ARRANGE: Configurar mock com delay
      const user = userEvent.setup();
      mockCheckoutContext.calculateDeliveryFee.mockImplementation(() =>
        new Promise(resolve => setTimeout(() => resolve(8.50), 500))
      );

      // ACT: Selecionar endere√ßo
      renderDeliveryStep();
      
      const deliveryCard = screen.getByTestId('delivery-option');
      await user.click(deliveryCard);
      
      await waitFor(() => {
        const addressCard = screen.getByTestId('saved-address-1');
        return user.click(addressCard);
      });

      // ASSERT: Verificar loading
      expect(screen.getByText('Calculando taxa...')).toBeInTheDocument();
    });
  });

  /**
   * GRUPO: Testes de Navega√ß√£o
   */
  describe('Navega√ß√£o de Etapas', () => {
    test('deve habilitar bot√£o Continuar ap√≥s selecionar retirada', async () => {
      // ARRANGE: Configurar userEvent
      const user = userEvent.setup();

      // ACT: Selecionar retirada
      renderDeliveryStep();
      const pickupCard = screen.getByTestId('pickup-option');
      await user.click(pickupCard);

      // ASSERT: Verificar que bot√£o est√° habilitado
      const continueButton = screen.getByText('Continuar');
      expect(continueButton).not.toBeDisabled();
    });

    test('deve habilitar bot√£o Continuar ap√≥s selecionar entrega e endere√ßo', async () => {
      // ARRANGE: Configurar userEvent
      const user = userEvent.setup();
      mockCheckoutContext.calculateDeliveryFee.mockResolvedValue(8.50);

      // ACT: Selecionar entrega e endere√ßo
      renderDeliveryStep();
      
      const deliveryCard = screen.getByTestId('delivery-option');
      await user.click(deliveryCard);
      
      await waitFor(() => {
        const addressCard = screen.getByTestId('saved-address-1');
        return user.click(addressCard);
      });

      // ASSERT: Verificar que bot√£o est√° habilitado
      await waitFor(() => {
        const continueButton = screen.getByText('Continuar');
        expect(continueButton).not.toBeDisabled();
      });
    });

    test('deve avan√ßar para pr√≥xima etapa ao clicar em Continuar', async () => {
      // ARRANGE: Configurar userEvent
      const user = userEvent.setup();

      // ACT: Selecionar retirada e continuar
      renderDeliveryStep();
      
      const pickupCard = screen.getByTestId('pickup-option');
      await user.click(pickupCard);
      
      const continueButton = screen.getByText('Continuar');
      await user.click(continueButton);

      // ASSERT: Verificar navega√ß√£o
      expect(mockCheckoutContext.nextStep).toHaveBeenCalled();
    });

    test('deve voltar para etapa anterior', async () => {
      // ARRANGE: Configurar userEvent
      const user = userEvent.setup();

      // ACT: Clicar em voltar
      renderDeliveryStep();
      const backButton = screen.getByText('Voltar');
      await user.click(backButton);

      // ASSERT: Verificar navega√ß√£o
      expect(mockCheckoutContext.prevStep).toHaveBeenCalled();
    });
  });

  /**
   * GRUPO: Testes de Estados Especiais
   */
  describe('Estados Especiais', () => {
    test('deve mostrar mensagem quando usu√°rio n√£o tem endere√ßos salvos', () => {
      // ARRANGE: Usu√°rio sem endere√ßos
      const userWithoutAddresses = createMockUser({ addresses: [] });

      // ACT: Renderizar com usu√°rio sem endere√ßos
      renderDeliveryStep({ user: userWithoutAddresses });
      
      // Selecionar entrega
      const deliveryCard = screen.getByTestId('delivery-option');
      fireEvent.click(deliveryCard);

      // ASSERT: Verificar mensagem
      expect(screen.getByText('Nenhum endere√ßo salvo')).toBeInTheDocument();
    });

    test('deve tratar erro na busca de CEP', async () => {
      // ARRANGE: Configurar mock de CEP com erro
      const user = userEvent.setup();
      global.fetch = jest.fn().mockRejectedValue(new Error('Erro de rede'));

      // ACT: Tentar buscar CEP inv√°lido
      renderDeliveryStep();
      
      const deliveryCard = screen.getByTestId('delivery-option');
      await user.click(deliveryCard);
      
      await waitFor(async () => {
        const addButton = screen.getByText('Adicionar Novo Endere√ßo');
        await user.click(addButton);
      });
      
      await waitFor(async () => {
        const cepField = screen.getByLabelText(/CEP/i);
        await user.type(cepField, '00000000');
      });

      // ASSERT: Verificar tratamento do erro
      await waitFor(() => {
        expect(screen.getByText('CEP n√£o encontrado')).toBeInTheDocument();
      });
    });

    test('deve manter estado ao trocar entre retirada e entrega', async () => {
      // ARRANGE: Configurar userEvent
      const user = userEvent.setup();

      // ACT: Selecionar entrega, depois retirada, depois entrega novamente
      renderDeliveryStep();
      
      const deliveryCard = screen.getByTestId('delivery-option');
      await user.click(deliveryCard);
      
      const pickupCard = screen.getByTestId('pickup-option');
      await user.click(pickupCard);
      
      await user.click(deliveryCard);

      // ASSERT: Verificar que endere√ßos salvos ainda s√£o mostrados
      await waitFor(() => {
        expect(screen.getByText('Rua das Flores, 123')).toBeInTheDocument();
      });
    });
  });
});
